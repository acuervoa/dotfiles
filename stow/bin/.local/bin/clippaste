#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'USAGE'
Uso: clippaste [--mime <mime>] [--primary]

Pega (stdout) el contenido del portapapeles.

Opciones:
  --mime <mime>    Tipo MIME. Default: text/plain
  --primary        Usa selección PRIMARY (X11) en vez de CLIPBOARD
  -h, --help       Ayuda
USAGE
}

mime="text/plain"
selection="clipboard"

while (($#>0)); do
  case "$1" in
    --mime) shift; mime="${1:-}"; [ -n "$mime" ] || { echo "[clippaste] Falta valor para --mime" >&2; exit 2; } ;;
    --primary) selection="primary" ;;
    -h|--help) usage; exit 0 ;;
    *) echo "[clippaste] Opción no reconocida: $1" >&2; usage >&2; exit 2 ;;
  esac
  shift
done

if command -v wl-paste >/dev/null 2>&1 && [ -n "${WAYLAND_DISPLAY:-}" ]; then
  wl-paste --no-newline --type "$mime" || wl-paste --no-newline
  exit 0
fi

if command -v xclip >/dev/null 2>&1 && [ -n "${DISPLAY:-}" ]; then
  xclip -selection "$selection" -t "$mime" -o 2>/dev/null || xclip -selection "$selection" -o
  exit 0
fi

if command -v xsel >/dev/null 2>&1 && [ -n "${DISPLAY:-}" ]; then
  if [ "$selection" = "primary" ]; then xsel --primary --output; else xsel --clipboard --output; fi
  exit 0
fi

echo "[clippaste] No hay backend (wl-paste/xclip/xsel)" >&2
exit 1
