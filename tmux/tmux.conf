##### =========================
#####  TMUX â€” Config final (prefix C-s)
##### =========================

##### Rendimiento / compat
set -g assume-paste-time 1               # mejor detecciÃ³n de pegado
set -s escape-time 0                     # sin retardo tras ESC
set -g focus-events on                   # eventos de foco
set -g history-limit 100000              # scrollback grande

##### Terminal / colores / shell
if-shell 'infocmp tmux-256color >/dev/null 2>&1' \
  'set -g default-terminal "tmux-256color"' \
  'set -g default-terminal "xterm-256color"'

# Display time
set -g display-time 1200          # 1.2s para los mensajes de la barra
set -g display-panes-time 1500    # 1.5s para el overlay de panes

# RGB robusto segÃºn versiÃ³n (â‰¥3.2 usa terminal-features; si no Tc)
run-shell -b 'v=$(tmux -V | awk "{print \$2}"); case "$v" in 3.[2-9]*|[4-9].*) tmux set -as terminal-features "alacritty:RGB,xterm-kitty:RGB,xterm-256color:RGB";; *) tmux set -g terminal-overrides ",alacritty:Tc,xterm-kitty:Tc,xterm-256color:Tc";; esac'

# Shell por defecto
if-shell 'command -v bash >/dev/null 2>&1' \
  'set -g default-shell "/usr/bin/bash"' \
  'set -g default-shell "/bin/sh"'

##### Prefix y envÃ­o
unbind C-b
set -g prefix C-s
bind C-s send-prefix  # enviar prefijo a apps dentro

##### Ãndices
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on

##### RatÃ³n + Copy-mode + clipboard
set -g mouse on
setw -g mode-keys vi

# Clipboard: autodetecta wl-copy/xclip y usa OSC52 si estÃ¡
if-shell 'command -v wl-copy >/dev/null 2>&1' \
  'set -g @copy_cmd "wl-copy"' \
  'set -g @copy_cmd "xclip -selection clipboard"'
if-shell -b 'test -z "#{@copy_cmd}"' "set -g @copy_cmd 'cat >/dev/null'"
set -g set-clipboard on

# Copy-mode vi: Enter/y copian al sistema
unbind -T copy-mode-vi Enter
bind   -T copy-mode-vi Enter  send-keys -X copy-pipe-and-cancel "#{@copy_cmd}"
unbind -T copy-mode-vi y
bind   -T copy-mode-vi y      send-keys -X copy-pipe-and-cancel "#{@copy_cmd}"
bind   -T copy-mode-vi v      send-keys -X begin-selection
bind   -T copy-mode-vi V      send-keys -X select-line
bind   -T copy-mode-vi C-v    send-keys -X rectangle-selection
bind   -T copy-mode-vi Escape send-keys -X cancel

##### NavegaciÃ³n panes (sin choques con i3)
bind -r h select-pane -L
bind -r j select-pane -D
bind -r k select-pane -U
bind -r l select-pane -R
set -g repeat-time 300
set -g wrap-search on
bind -r Tab  select-pane -t :.+
bind -r BTab select-pane -t :.-
bind '{' swap-pane -U
bind '}' swap-pane -D
bind -n M-S-Left  resize-pane -L 5
bind -n M-S-Right resize-pane -R 5
bind -n M-S-Up    resize-pane -U 2
bind -n M-S-Down  resize-pane -D 2

##### Ventanas
bind -n M-Left  previous-window
bind -n M-Right next-window
bind -n C-PageDown next-window
bind -n C-PageUp   previous-window
bind a last-window

##### NavegaciÃ³n inteligente con Vim/Neovim
is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^[TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
bind-key -n C-h if-shell "$is_vim" 'send-keys C-h' 'select-pane -L'
bind-key -n C-j if-shell "$is_vim" 'send-keys C-j' 'select-pane -D'
bind-key -n C-k if-shell "$is_vim" 'send-keys C-k' 'select-pane -U'
bind-key -n C-l if-shell "$is_vim" 'send-keys C-l' 'select-pane -R'

##### Splits / gestiÃ³n panes
bind '"' split-window -v -c "#{pane_current_path}"
bind %   split-window -h -c "#{pane_current_path}"
bind BSpace kill-pane -a
bind q   kill-pane
bind o   select-pane -t :.+
bind Z   resize-pane -Z \; display-message "ðŸ”Ž Zoom: #{window_zoomed_flag}"

##### Sync panes
bind -n F10 setw synchronize-panes \; display "ðŸ”— Sync: #{?pane_synchronized,on,off}"

##### Reload de config
unbind r
bind   r source-file ~/.tmux.conf \; display "ðŸ”„ Config reloaded!"

##### Plugins (TPM) â€” limpios (sin yank ni tmux-fzf)
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @plugin 'jaclu/tmux-menus'
set -g @plugin 'omerxx/tmux-sessionx'
set -g @plugin 'laktak/extrakto'

##### Ajustes plugins
set -g @continuum-save-interval '15'
set -g @continuum-boot 'on'
set -g @continuum-restore 'off'
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-nvim 'session'
set -g @resurrect-save 'M-s'
set -g @resurrect-restore 'M-r'
set -g @vim_tmux_navigator_no_mappings 1
set -g @menus_trigger 'm'
set -g @copy_command "#{@copy_cmd}"   # tmux-yank compat si se aÃ±ade en algÃºn momento

# Sesiones (SessionX si estÃ¡; si no, fallback)
unbind s
bind s choose-tree -sw
unbind S
bind S if-shell 'test -x ~/.tmux/plugins/tmux-sessionx/scripts/sessionx.sh' \
  'run-shell -b "~/.tmux/plugins/tmux-sessionx/scripts/sessionx.sh"' \
  'choose-tree -sw'
bind f command-prompt -p 'Find:' 'find-window "%%"'

# Extrakto
set -g @extrakto_key 'x'
set -g @extrakto_split 'v'

##### Tema bÃ¡sico y status
set -g pane-border-style        "fg=brightblack"
set -g pane-active-border-style "fg=green"
set -g pane-border-status off
set -g pane-border-format " #P: #{pane_current_command} â€” #{b:pane_current_path} "
set -g display-panes-time 5000

set -g status on
set -g status-interval 5
set -g status-justify centre
set -g status-position bottom
set -g status-style "bg=#1e1e2e,fg=#cdd6f4"

setw -g window-status-separator "|"

# Lista de ventanas: colores y flags 
setw -g window-status-style "bg=#1e1e2e,fg=#a6adc8"
setw -g window-status-format " #[nobold] #I:#W "
setw -g window-status-current-style "bg=#585b70,fg=#f5e0dc,bold"
setw -g window-status-current-format " #[bold]#I:#W#{?window_zoomed_flag, [Z],} "

# Status left: sesiÃ³n, usuario@host, ruta acortada
set -g status-left-length 80
set -g status-left "\
#[fg=#89b4fa]î‚¶#[bg=#89b4fa,fg=#1e1e2e] #(printf \"%.10s\" '#S') #[bg=#1e1e2e,fg=#89b4fa]î‚´ \
#[fg=#94e2d5]î‚¶#[bg=#94e2d5,fg=#1e1e2e] #(printf \"%.12s\" \"$USER@#{host_short}\" | tr -d '\n') #[bg=#1e1e2e,fg=#94e2d5]î‚´ \
#[fg=#f9e2af]î‚¶#[bg=#f9e2af,fg=#1e1e2e] #(bash -lc '[ -x ~/.tmux/scripts/shorten_path.sh ] && ~/.tmux/scripts/shorten_path.sh \"#{pane_current_path}\"  || printf \"%.50s\" \"#{pane_current_path}\"' | tr -d '\n') #[bg=#1e1e2e,fg=#f9e2af]î‚´"

# Status right: PREFIX, COPY, rama git, pill de red
# - @net_if vacÃ­o => autodetecciÃ³n de interfaces activas (fallback seguro por defecto)
# - Si defines @net_if en ~/.tmux.conf.local o con "t net-if" se usarÃ¡ ese orden
set -g @net_if ""
set -g status-right-length 200
set -g status-right "\
#[fg=#f38ba8]î‚¶#[bg=#f38ba8,fg=#1e1e2e]#{?client_prefix,âŒ¨PREFIX,}#[bg=#1e1e2e,fg=#f38ba8]î‚´\
#[fg=#94e2d5]î‚¶#[bg=#94e2d5,fg=#1e1e2e]#{?pane_in_mode,ïŽ COPY,}#[bg=#1e1e2e,fg=#94e2d5]î‚´\
#[fg=#cba6f7]î‚¶#[bg=#cba6f7,fg=#1e1e2e]#(sh -lc 'cd \"#{pane_current_path}\" 2>/dev/null && git rev-parse --abbrev-ref HEAD 2>/dev/null || true | tr -d \"\n\"')#[bg=#1e1e2e,fg=#cba6f7]î‚´"



# TÃ­tulos y renombres
set -g set-titles off
set -g allow-rename off
setw -g automatic-rename off

# Teclas extendidas y passthrough si aplica (>=3.4)
set -g xterm-keys on
run-shell -b 'v=$(tmux -V | awk "{print \$2}"); case "$v" in 3.4*|3.[5-9]*|[4-9].*) tmux set -g allow-passthrough on;; esac'

# Entorno al adjuntar
set -g update-environment "DISPLAY SSH_AUTH_SOCK SSH_ASKPASS WAYLAND_DISPLAY XDG_SESSION_TYPE"

# Salidas
setw -g remain-on-exit off
set -g exit-empty on

##### PRODUCTIVIDAD EXTRA

# Ãšltimo pane, overlaym break/join
unbind +
unbind \|
unbind _
unbind !

bind \; last-pane                                 # alterna entre los dos Ãºltimos panes
bind Space display-panes                          # overlay numerado de panes
bind ! run-shell 'cmd=$(tmux display-message -p "#{pane_current_command}"); dir=$(tmux display-message -p "#{b:pane_current_path}"); tmux break-pane -d -n "${cmd} â€” ${dir##*/}"' # saca pane a ventana nueva
bind + command-prompt -p 'join FROM s:w.p (ej: :3.1 o work:1.0)' 'join-pane -s %%'
bind \| command-prompt -p 'join H FROM s:w.p' 'join-pane -h -s %%'
bind _  command-prompt -p 'join V FROM s:w.p' 'join-pane -v -s %%'

# Layouts y swap de ventanas
bind L select-layout -n                           # siguiente layout
bind E select-layout even-horizontal              # layout horizontal
bind V select-layout even-vertical                # layout vertical
bind < swap-window -t -1                          # mueve ventana a la izq
bind > swap-window -t +1                          # mueve ventana a la dcha
bind , command-prompt -I "#W" 'rename-window "%%"' # renombra ventana
bind $ command-prompt -I "#S" 'rename-session "%%"' # renombra sesiÃ³n

# Nueva ventana en cws + utilidades
bind c new-window -c "#{pane_current_path}"       # nueva ventana en el mismo directorio
bind Y run-shell 'printf %s "#{pane_current_path}" | #{@copy_cmd} ; display-message "Ruta copiada"'

# Toggles sin F-Keys
bind T run-shell 'if [ "#{mouse}" = "on" ]; then tmux set -g mouse off \; display "mouse off"; else tmux set -g mouse on \; display "mouse on"; fi'
bind B run-shell 'if [ "#{status}" = "on" ]; then tmux set -g status off \; display "status off"; else tmux set -g status on \; display "status on"; fi'


# Popups (>=3.2): lazygit y btop
run-shell -b 'v=$(tmux -V|awk "{print \$2}"); case "$v" in 3.[2-9]*|[4-9].*) \
  tmux bind g display-popup -E -w 90% -h 90% -x C -y C "lazygit"; \
  tmux bind H display-popup -E -w 90% -h 90% -x C -y C "btop"; \
esac'

# Resurrect-save / restore binding
bind M-s run-shell -b "$HOME/.tmux/plugins/tmux-resurrect/scripts/save.sh"
bind M-r run-shell -b "$HOME/.tmux/plugins/tmux-resurrect/scripts/restore.sh"

# Abrir keymap-maestro.md en split inferior
bind K split-window -v -c "#{pane_current_path}" \
  "cd ~/dotfiles && exec glow keymap-maestro.md"

##### TPM
if-shell '[ -x "$HOME/.tmux/plugins/tpm/tpm" ]' 'run -b "$HOME/.tmux/plugins/tpm/tpm"' 'display-message "TPM no encontrado; salto plugins"'

